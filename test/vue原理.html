<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
	</head>
	<body>
		<script type="text/javascript">
			function observe(data){
				if(!data||typeof(data)!=='object'){
					return ;
				}
				Object.keys(data).forEach(function(key){
					  defineReactive(data,key,data[key]);
				})
			}
			function defineReactive(obj,key,value){
				let dep=new Dep();
				observe(value);  //监听子属性值
				Object.defineProperty(obj,key,{
					enumerable:true,
					configurable:false,
					get:function getter(){
						Dep.target&&dep.addSub(Dep.target);
						// 由于需要在闭包内添加watcher，所以通过Dep定义一个全局target属性，暂存watcher, 添加完移除
						return value;
					},
					set:function setter(newValue){
						if(newValue===value){
							return ;
						}
						else{
						    value=newValue;
						    dep.notify(); // 通知所有订阅者
						}
					}
				})
			}
			class Dep{
				constructor(){
					this.subs=[];
				}
				addSub(sub){
					this.subs.push(sub);
				}
				notify(){
					this.subs.forEach(function(sub){
						sub.update();
					})
				}
			}
			class Watcher{
				constructor(){
					Dep.target=this;
				}
				update(){
					console.log("要更新视图啦！");
				}
			}
			class Vue{
				constructor(options){
					this._data=options.data;
					observe(this._data);
					let watcher=new Watcher();
					console.log("render~~~",this._data.test);
					this._data.test='hi';
					Dep.target=null;
				}
			}
			let vue=new Vue({
				data:{
					test:'hello'
				}
			})
		</script>
	</body>
</html>
